#This file was autogenerated by confd from consul
#{{ $host_name := (getenv "HOSTNAME")}}
#{{ $host_conf := ( print "/hosts/" $host_name "/services" ) }}
#{{ $tree := (print $host_conf "/")}}
#{{ range lsdir $tree }}
#    {{ $service := . }}
#    {{ $enabled := getv (print "/config/nginx/" $service "/enabled") "false"}}
#    {{ if eq $enabled "true" }}
#        {{ $conf_name := getv (print $tree $service "/conf_name") "default"}}
#        {{ $fqdn := getv (print "/config/route-manager/prod/services/" $service "/" $conf_name "/external_zone") (getv (print "config/route-manager/prod/services/" $service "/default/external_zone") (print $service "d.welespay.ru")) }}
#        {{ $fqdn_vpn := getv (print "/config/route-manager/prod/services/" $service "/" $conf_name "/vpn_zone") (getv (print "config/route-manager/prod/services/" $service "/default/vpn_zone") (print $service "d-vpn.welespay.ru")) }}
#        {{ $fqdn_testing := getv (print "/config/route-manager/prod/services/" $service "/" $conf_name "/testing_zone") (getv (print "config/route-manager/prod/services/" $service "/default/testing_zone") (print $service "d-test.welespay.ru")) }}
#        {{ $fqdn_testing_vpn:= getv (print "/config/route-manager/prod/services/" $service "/" $conf_name "/testing_zone_vpn") (getv (print "config/route-manager/prod/services/" $service "/default/testing_zone_vpn") (print $service "d-test-vpn.welespay.ru")) }}        
#        {{ $upstream_port := getv (print "/config/nginx/" $service "/upstream_port") (print "MUST SPECIFY HTTP PORT IN CONSUL") }}
#        {{ $keepalive := getv (print "/config/nginx/" $service "/" $conf_name "/keepalive") "keepalive 10;"}}
#        {{ $allow_external := getv (print "/config/nginx/" $service "/allow_external") (print "include             snippets/access-internal.conf;") }}
#        {{ $server_extra_includes := getv (print "/config/nginx/" $service "/server_extra_includes") ""}}
#        {{ $root_extra_includes := getv (print "/config/nginx/" $service "/root_extra_includes") ""}}
#        {{ $upstream_name := print $service "_" $host_name "_" $conf_name }}

upstream {{print $upstream_name }}_backend {
    server                  localhost:{{print $upstream_port }};

    {{print $keepalive }}
}

server {
    listen                  80;
    server_name             {{ print $fqdn }} {{ print $fqdn_vpn }} {{ print $fqdn_testing }} {{ print $fqdn_testing_vpn }};
    return                  302      https://$server_name$request_uri;
}

server {
    listen                  443;
    server_name             {{ print $fqdn }} {{ print $fqdn_vpn }} {{ print $fqdn_testing }} {{ print $fqdn_testing_vpn }};
    include                 snippets/ssl-keys.conf;
    include                 snippets/ssl-params.conf;
    client_max_body_size    2G;
    {{ print $server_extra_includes }}
    location / {
        proxy_pass          http://{{ print $upstream_name "_backend" }}/;
        proxy_read_timeout  600s;
        include             snippets/proxy.conf;
        include             snippets/ssl-proxy.conf;
        {{ print $allow_external }}
        {{ print $root_extra_includes }}
    }

}
     {{end}}
{{end}}
